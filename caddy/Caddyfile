{
	admin off
}
# generate cert for turn.fariszr.com, but don't serve anything
turn.fariszr.com {
	abort
}

pa.fariszr.com {
	rewrite /js/pls.js /js/plausible.js
	rewrite /js/pls2.js /js/plausible.hash.js
	rewrite /js/pls3.js /js/plausible.outbound-links.js
	rewrite /js/pls4.js /js/plausible.hash.outbound-links.js
	reverse_proxy plausible:8000
	encode zstd gzip
}

matrix.fariszr.com {
	reverse_proxy synapse:8008
	encode zstd gzip
	# Serves the Matrix client .well-known JSON configuration file
	handle /.well-known/matrix/client {
		root * /static # Set root for this handler
		try_files /client =404 # Try to serve /static/client, else 404
		file_server # Serve the file found by try_files (or handle 404 from try_files)
		header Content-Type application/json
		# Ensures correct content type for JSON
	}
}

# Updated LiveKit reverse proxy to use the new domain
matrixrtc.fariszr.com {
	encode zstd gzip

	# Route JWT requests to the lk-jwt-service container on its internal port 8080
	handle /livekit/jwt* {
		reverse_proxy lk-jwt-service:8080
	}

	# Route SFU WebSocket requests to the livekit container on its internal port 7880
	handle /livekit/sfu* {
		reverse_proxy livekit:7880 {
			# Required for WebSocket proxying
			header_up Host {http.reverse_proxy.upstream.hostport}
			header_up Upgrade {header.Upgrade}
			header_up Connection {header.Connection}
		}
	}
	# Route SFU WebSocket requests to the livekit container on its internal port 7880
	handle /sfu/get* {
		reverse_proxy lk-jwt-service:8080 {
			header_up Access-Control-Allow-Origin "*"
			header_up Access-Control-Allow-Methods "POST"
			header_up Access-Control-Allow-Headers "Accept, Content-Type, Content-Length, Accept-Encoding, X-CSRF-Token"
		}
	}

	# Optional: Add a default handler if needed, e.g., redirect or show a message
	# handle {
	#    respond "LiveKit backend" 200
	# }
}

import /etc/caddy/configs/*.caddyfile
