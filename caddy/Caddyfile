{
	admin off
}
# generate cert for turn.fariszr.com, but don't serve anything
turn.fariszr.com {
	abort
}

pa.fariszr.com {
	rewrite /js/pls.js /js/plausible.js
	rewrite /js/pls2.js /js/plausible.hash.js
	rewrite /js/pls3.js /js/plausible.outbound-links.js
	rewrite /js/pls4.js /js/plausible.hash.outbound-links.js
	reverse_proxy plausible:8000
	encode zstd gzip
}

matrix.fariszr.com {
	reverse_proxy synapse:8008
	encode zstd gzip
	# Updated .well-known to point livekit_service_url to the JWT endpoint on the new domain
	respond /.well-known/matrix/client 200 {
		body `{
			"m.homeserver": {
				"base_url": "https://matrix.fariszr.com"
			},
			"org.matrix.msc4143.rtc_foci": [
				{
					"type": "livekit",
					"livekit_service_url": "https://matrixrtc.fariszr.com/livekit/jwt"
				}
			]
		}`
		headers {
			Content-Type application/json
			Access-Control-Allow-Origin *
			# Add other CORS headers if needed based on client requirements
            # Access-Control-Allow-Methods GET, POST, OPTIONS
            # Access-Control-Allow-Headers Authorization, Content-Type
		}
	}
}

# Updated LiveKit reverse proxy to use the new domain
matrixrtc.fariszr.com {
	encode zstd gzip

	# Route JWT requests to the lk-jwt-service container on its internal port 8080
	handle /livekit/jwt* {
		reverse_proxy lk-jwt-service:8080
	}

	# Route SFU WebSocket requests to the livekit container on its internal port 7880
	handle /livekit/sfu* {
		reverse_proxy livekit:7880 {
			# Required for WebSocket proxying
			header_up Host {http.reverse_proxy.upstream.hostport}
			header_up X-Forwarded-Host {host}
            header_up Upgrade {header.Upgrade}
            header_up Connection {header.Connection}
		}
	}

    # Optional: Add a default handler if needed, e.g., redirect or show a message
    # handle {
    #    respond "LiveKit backend" 200
    # }
}

import /etc/caddy/configs/*.caddyfile
